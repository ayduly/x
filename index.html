<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Misliscore</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #FFD700; --basket: #FF9800; --dark: #121212; --card: #1E1E1E; --text: #E0E0E0; --border: #333; }
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; color: var(--text); background: var(--dark); min-height: 100vh; }

    header { background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); padding: 15px; text-align: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 24px; font-weight: 900; color: var(--primary); letter-spacing: -1px; }

    /* Butonlar */
    .sport-tabs { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
    .sport-btn {
      background: transparent; border: 1px solid var(--border); color: #888;
      padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.3s;
    }
    .sport-btn.active-fut { background: var(--primary); color: #000; border-color: var(--primary); }
    .sport-btn.active-bas { background: var(--basket); color: #000; border-color: var(--basket); }
    
    .back-btn { display:none; margin: 10px auto; background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; }

    .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }

    .match-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      padding: 16px; margin-bottom: 12px; display: flex; align-items: center;
      transition: transform 0.2s; cursor: pointer;
    }
    .match-card:hover { transform: translateY(-3px); border-color: #555; }
    
    .time-box { width: 50px; text-align: center; font-size: 11px; color: #888; border-right: 1px solid var(--border); margin-right: 15px; display: flex; flex-direction: column; justify-content: center; }
    .teams { flex: 1; }
    .team-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; font-weight: 600; }
    .league-name { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .score { font-family: monospace; font-size: 14px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }
    
    .loading { text-align: center; color: #666; margin-top: 50px; }
    .error-msg { background: rgba(244, 67, 54, 0.1); color: #ff5252; padding: 15px; border-radius: 8px; text-align: center; display: none; margin-top: 20px;}
  </style>
</head>
<body>

<header>
  <div class="logo">MISLISCORE</div>
  <div class="sport-tabs">
    <button class="sport-btn active-fut" onclick="switchSport('football', this)">FUTBOL</button>
    <button class="sport-btn" onclick="switchSport('basketball', this)">BASKETBOL</button>
  </div>
</header>

<div class="container">
  <button id="basket-back" class="back-btn" onclick="init()">← Liglere Dön</button>
  <div id="error-area" class="error-msg"></div>
  <div id="match-list">
    <div class="loading">Yükleniyor...</div>
  </div>
</div>

<script>
let currentSport = 'football';

// Sayfa ilk açıldığında çalıştır
document.addEventListener('DOMContentLoaded', () => {
    init();
});

function switchSport(sport, btn) {
  currentSport = sport;
  
  // Buton stillerini ayarla
  document.querySelectorAll('.sport-btn').forEach(b => {
      b.classList.remove('active-fut');
      b.classList.remove('active-bas');
  });
  
  if(sport === 'football') btn.classList.add('active-fut');
  else btn.classList.add('active-bas');
  
  // Geri butonunu gizle ve listeyi sıfırla
  document.getElementById('basket-back').style.display = 'none';
  document.getElementById("match-list").innerHTML = '<div class="loading">Veriler Çekiliyor...</div>';
  
  // Fonksiyonu çalıştır
  init();
}

async function init() {
  const listDiv = document.getElementById("match-list");
  const errorDiv = document.getElementById("error-area");
  
  listDiv.innerHTML = '<div class="loading">Yükleniyor...</div>';
  errorDiv.style.display = 'none';
  document.getElementById('basket-back').style.display = 'none';

  try {
    let endpoint = "";
    if (currentSport === 'football') {
        endpoint = "/api/sportbex/league/1/matches?page=1&perPage=20"; 
    } else {
        // Basketbol Ligleri (ID: 7522)
        endpoint = "/api/basket/competitions/7522"; 
    }

    console.log("İstek gönderiliyor:", endpoint); // Hata ayıklama

    const res = await fetch(endpoint);
    if (!res.ok) throw new Error(`API Hatası: ${res.status}`);
    const data = await res.json();
    
    console.log("Gelen Veri:", data); // Hata ayıklama

    let items = [];
    if(currentSport === 'football') {
       items = Array.isArray(data) ? data : (data.results || data.data || []);
       renderFootball(items);
    } else {
       // Basketbol verisi 'result' içinde olabilir
       items = Array.isArray(data) ? data : (data.result || []);
       renderBasketCompetitions(items);
    }

  } catch (err) {
    console.error(err);
    listDiv.innerHTML = "";
    errorDiv.style.display = 'block';
    errorDiv.innerHTML = `Hata: ${err.message}<br><small>Lütfen Netlify'a yüklediğinden emin ol.</small>`;
  }
}

function renderFootball(data) {
  const listDiv = document.getElementById("match-list");
  let html = "";
  
  if(data.length === 0) {
      listDiv.innerHTML = "<div class='loading'>Şu an futbol maçı bulunamadı.</div>"; 
      return;
  }

  data.forEach(m => {
    let h = m.homeTeam?.name || m.home_team || "Ev Sahibi";
    let a = m.awayTeam?.name || m.away_team || "Deplasman";
    let hs = m.score?.home ?? "-";
    let as = m.score?.away ?? "-";
    let time = m.matchDate ? new Date(m.matchDate).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : 'MS';

    let id = m.matchId || m.id || m._id;
    let url = id ? `match.html?id=${id}&sport=football` : '#';

    html += `
      <div class="match-card" onclick="location.href='${url}'">
        <div class="time-box">FUT<br>${time}</div>
        <div class="teams">
          <div class="team-row"><span>${h}</span> <span class="score">${hs}</span></div>
          <div class="team-row"><span>${a}</span> <span class="score">${as}</span></div>
        </div>
      </div>`;
  });
  listDiv.innerHTML = html;
}

function renderBasketCompetitions(data) {
  const listDiv = document.getElementById("match-list");
  let html = "";
  
  if(data.length === 0) {
      listDiv.innerHTML = "<div class='loading'>Aktif Basketbol ligi bulunamadı.</div>"; 
      return;
  }

  data.forEach(item => {
    let comp = item.competition || item; 
    let name = comp.name || "Bilinmeyen Lig";
    let region = comp.competitionRegion || "Dünya";
    let count = item.marketCount || 0;
    let id = comp.id; 

    // Tıklayınca loadBasketEvents çalışacak
    html += `
      <div class="match-card" style="border-left: 3px solid #FF9800;" onclick="loadBasketEvents('${id}', '${name}')">
        <div class="time-box" style="color:#FF9800">LİG</div>
        <div class="teams">
          <div class="league-name">${region}</div>
          <div class="team-row" style="font-size:16px"><span>${name}</span></div>
          <div style="font-size:11px; color:#666;">Aktif Market: ${count}</div>
        </div>
      </div>`;
  });
  listDiv.innerHTML = html;
}

// Basketbol Ligi Detayına Git (Maçları Getir)
async function loadBasketEvents(compId, compName) {
    const listDiv = document.getElementById("match-list");
    listDiv.innerHTML = `<div class='loading'>${compName} yükleniyor...</div>`;
    document.getElementById('basket-back').style.display = 'block';

    try {
        // Event Endpoint'i: event/7522/{ligId}
        const res = await fetch(`/api/basket/event/7522/${compId}`);
        const data = await res.json();
        
        let items = Array.isArray(data) ? data : (data.result || []);
        
        if(items.length === 0) {
            listDiv.innerHTML = "<div class='loading'>Bu ligde şu an açık maç yok.</div>";
            return;
        }

        let html = "";
        items.forEach(item => {
            let event = item.event || item;
            let name = event.name; 
            let time = event.openDate ? new Date(event.openDate).toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : 'VS';
            let id = event.id;

            // Maça Tıklayınca Detay Sayfasına Git
            let url = `match.html?id=${id}&sport=basketball`;

            html += `
              <div class="match-card" style="border-left: 3px solid #FF9800;" onclick="location.href='${url}'">
                <div class="time-box" style="color:#FF9800">${time}</div>
                <div class="teams">
                  <div class="league-name">${compName}</div>
                  <div class="team-row"><span>${name}</span></div>
                </div>
              </div>`;
        });
        listDiv.innerHTML = html;

    } catch (err) {
        listDiv.innerHTML = `<div class='loading'>Hata: ${err.message}</div>`;
    }
}
</script>
</body>
</html>