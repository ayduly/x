<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Misliscore - Canlı Skor</title>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { 
      --gold: #FFD700; 
      --dark-bg: #0a0a0a; 
      --card-bg: rgba(30, 30, 30, 0.6); 
      --text: #ffffff; 
      --border: rgba(255, 215, 0, 0.2);
    }
    
    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; padding: 0; 
      color: var(--text); 
      background-color: var(--dark-bg);
      min-height: 100vh;
      /* Optimize edilmiş arka plan deseni */
      background-image: 
        linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.95)),
        url('https://images.unsplash.com/photo-1556056504-5c7696c4c28d?q=80&w=1000&auto=format&fit=crop');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
    }

    header { 
      background: rgba(0, 0, 0, 0.8); 
      backdrop-filter: blur(15px); 
      padding: 15px; 
      text-align: center; 
      border-bottom: 1px solid var(--border); 
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    .logo { 
      font-family: 'Rajdhani', sans-serif; 
      font-size: 32px; 
      font-weight: 700; 
      color: var(--gold); 
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }

    .container { max-width: 600px; margin: 0 auto; padding: 20px 15px; }

    /* Lig Başlığı */
    .league-header {
      display: flex; align-items: center; gap: 10px;
      margin-top: 25px; margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 2px solid var(--gold);
    }
    .league-title {
      font-family: 'Rajdhani', sans-serif;
      font-size: 18px; font-weight: 700; color: var(--gold);
      text-transform: uppercase;
    }
    .flag-icon { width: 20px; height: 15px; border-radius: 2px; object-fit: cover; }

    /* Maç Kartı */
    .match-card {
      background: var(--card-bg); 
      backdrop-filter: blur(10px);
      border: 1px solid var(--border); 
      border-radius: 12px;
      padding: 15px; margin-bottom: 10px; 
      display: flex; align-items: center;
      transition: all 0.3s ease; cursor: pointer;
    }
    .match-card:hover { 
      transform: translateX(5px); 
      border-color: var(--gold); 
      background: rgba(255, 215, 0, 0.05);
    }

    .time-box { 
      width: 50px; text-align: center; font-size: 11px; color: #aaa; 
      border-right: 1px solid rgba(255,255,255,0.1); margin-right: 15px; 
      display: flex; flex-direction: column; justify-content: center; 
    }
    .status-live { color: #ff4444; font-weight: bold; animation: blink 1.5s infinite; }
    @keyframes blink { 50% { opacity: 0.5; } }

    .teams { flex: 1; }
    .team-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; font-weight: 600; letter-spacing: 0.5px; }
    .score { 
      font-family: 'Rajdhani', monospace; 
      font-size: 16px; font-weight: bold; 
      color: var(--gold); 
      background: rgba(0,0,0,0.4); 
      padding: 2px 8px; border-radius: 4px; 
      min-width: 25px; text-align: center;
    }

    .loading { text-align: center; color: var(--gold); margin-top: 50px; font-size: 18px; font-weight: bold; }
    .error-msg { background: rgba(200, 0, 0, 0.2); border: 1px solid #f00; color: #fff; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center;}
  </style>
</head>
<body>

<header><div class="logo">MISLISCORE</div></header>

<div class="container">
  <div id="error-area" class="error-msg" style="display:none"></div>
  <div id="match-list"><div class="loading">Maçlar Yükleniyor...</div></div>
</div>

<script>
// --- AYARLAR ---
const API_KEY = "8aPROa85kIgwqnTOhMQFEokJ4Jtc6oY1Pn9DUG7G"; 
// Futbol için geniş bir liste çekelim (ID: 1 genelde test verisi, 39 Premier Lig, 140 La Liga)
// Sportbex Trial'da veri alabilmek için genelde 1 kullanılır.
const LEAGUE_ID = "1"; 

async function init() {
  const listDiv = document.getElementById("match-list");
  const errorDiv = document.getElementById("error-area");

  try {
    // Daha fazla maç çekmek için perPage'i arttırdım
    const endpoint = `/api/sportbex/league/${LEAGUE_ID}/matches?page=1&perPage=50`;

    // HEADER'DA API KEY GÖNDERİLİYOR
    const res = await fetch(endpoint, {
        headers: { "sportbex-api-key": API_KEY }
    });

    if (!res.ok) throw new Error(`Sunucu Hatası: ${res.status}`);
    const data = await res.json();
    
    // Veriyi güvenli şekilde al
    let matches = [];
    if(Array.isArray(data)) matches = data;
    else if(data.results) matches = data.results;
    else if(data.data) matches = data.data;

    if(matches.length === 0) {
      listDiv.innerHTML = `<div class="loading" style="font-size:14px; opacity:0.7">Bu ligde şu an maç yok.<br>ID: ${LEAGUE_ID}</div>`;
      return;
    }

    renderGroupedMatches(matches);

  } catch (err) {
    console.error(err);
    listDiv.innerHTML = "";
    errorDiv.style.display = 'block';
    errorDiv.innerHTML = `Veri alınamadı: ${err.message}<br><small>vercel.json dosyanız yüklü mü?</small>`;
  }
}

// *** ÖNEMLİ: MAÇLARI LİGLERE GÖRE GRUPLAMA FONKSİYONU ***
function renderGroupedMatches(matches) {
  const listDiv = document.getElementById("match-list");
  
  // 1. Önce maçları Lig İsimlerine göre gruplayalım
  const leagues = {};

  matches.forEach(m => {
    // Lig ismini bul (Competition Name)
    let leagueName = "Diğer Maçlar";
    if (m.competition && m.competition.name) leagueName = m.competition.name;
    else if (m.league_name) leagueName = m.league_name;
    
    if (!leagues[leagueName]) {
      leagues[leagueName] = [];
    }
    leagues[leagueName].push(m);
  });

  // 2. Gruplanmış veriyi ekrana basalım
  let html = "";

  for (const [leagueName, leagueMatches] of Object.entries(leagues)) {
    // Lig Başlığı
    html += `
      <div class="league-header">
        <span class="league-title">${leagueName}</span>
      </div>
    `;

    // O ligin maçları
    leagueMatches.forEach(m => {
      let h = m.homeTeam?.name || m.home_team || "Ev Sahibi";
      let a = m.awayTeam?.name || m.away_team || "Deplasman";
      
      // Skor kontrolü
      let hs = m.score?.home ?? m.home_score ?? "-";
      let as = m.score?.away ?? m.away_score ?? "-";
      
      // Saat
      let d = m.matchDate || m.date ? new Date(m.matchDate || m.date) : new Date();
      let time = d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
      
      // ID
      let id = m.matchId || m.id || m._id;
      let url = id ? `match.html?id=${id}` : '#';

      html += `
        <div class="match-card" onclick="location.href='${url}'">
          <div class="time-box">
             <span>${time}</span>
             <span style="font-size:9px; margin-top:3px">MS</span>
          </div>
          <div class="teams">
            <div class="team-row">
               <span>${h}</span> <span class="score">${hs}</span>
            </div>
            <div class="team-row">
               <span>${a}</span> <span class="score">${as}</span>
            </div>
          </div>
        </div>
      `;
    });
  }

  listDiv.innerHTML = html;
}

init();
</script>
</body>
</html>